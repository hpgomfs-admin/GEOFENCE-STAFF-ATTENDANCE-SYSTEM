<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>HPG Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    /* --- ORIGINAL UI STYLES --- */
    body { 
      background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%); 
      font-family: 'Poppins', sans-serif; 
      padding: 20px; 
      min-height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }
    
    .app-card { 
      width: 100%; 
      max-width: 400px; 
      background: white; 
      border-radius: 24px; 
      padding: 35px 25px; 
      box-shadow: 0 15px 35px rgba(0, 50, 80, 0.1); 
      text-align: center; 
    }
    
    .title-main { font-weight: 700; color: #0f4c75; font-size: 1.1rem; text-transform: uppercase; margin-bottom: 5px; }
    .title-sub { font-weight: 500; color: #3282b8; font-size: 0.9rem; margin-bottom: 2px; }
    .title-hospital { font-weight: 600; color: #1b262c; font-size: 0.85rem; }

    /* SMART BUTTON */
    .smart-btn { 
      width: 100%; height: 100px; border-radius: 20px; 
      font-size: 1.5rem; font-weight: 700; color: white;
      display: flex; align-items: center; justify-content: center; gap: 10px; 
      box-shadow: 0 8px 20px rgba(0,0,0,0.1); transition: all 0.2s; border: none; 
      margin-bottom: 20px; 
    }
    .smart-btn:active { transform: scale(0.96); }
    .btn-mode-in { background: linear-gradient(135deg, #1cc88a, #13855c); }
    .btn-mode-out { background: linear-gradient(135deg, #e74a3b, #be2617); }

    /* UTILS */
    .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1055; width: 90%; max-width: 350px; }
    #loadingOverlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); z-index: 10; display: none; align-items: center; justify-content: center; border-radius: 24px; }

    /* PRINT & REPORT STYLES */
    #printSection { display: none; background: white; font-family: Arial, sans-serif; color: black; padding: 20px; }
    .punch-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 20px; }
    .punch-table th, .punch-table td { border: 1px solid black; padding: 4px; text-align: center; height: 25px; }
    .punch-table th { background: #eee; font-weight: bold; }
    .weekend-row { background-color: #f2f2f2; }
    
    @media print {
      body * { visibility: hidden; }
      #printSection, #printSection * { visibility: visible; }
      #printSection { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
      .no-print { display: none !important; }
    }
  </style>
</head>
<body>

  <div class="toast-container">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0 shadow-lg">
      <div class="d-flex">
        <div class="toast-body fs-6 fw-bold">‚úÖ Successful Punch!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <div class="app-card no-print" id="mainApp">
    <div class="logo-header mb-4 border-bottom pb-3">
      <div class="title-main">GEO-FENCED PUNCHCARD SYSTEM</div>
      <div class="title-sub">Jabatan Bedah Mulut & Maksilofasial</div>
      <div class="title-hospital">Hospital Pasir Gudang</div>
    </div>
    
    <div id="loadingOverlay"><div class="spinner-border text-primary"></div></div>

    <div id="loginView">
      <p class="text-muted small mb-3">Verify your email to access.</p>
      <input type="email" id="email" class="form-control mb-3 text-center" placeholder="Enter Work Email">
      <button onclick="reqOTP()" class="btn btn-primary w-100 mb-3">Send Access Code</button>
      <div id="otpArea" style="display:none;">
        <input type="tel" id="otp" class="form-control mb-3 text-center" placeholder="6-Digit OTP">
        <button onclick="doLogin()" class="btn btn-success w-100">Verify & Login</button>
      </div>
    </div>

    <div id="punchView" class="d-none">
      <h4 id="uName" class="fw-bold mb-1 text-dark">Welcome</h4>
      <span id="uShift" class="badge bg-light text-primary border mb-3">--</span>

      <div id="lastActionBox" class="alert alert-secondary p-2 small mb-4">
         Last Action: <span id="lastActionText" class="fw-bold">None</span>
      </div>
      
      <button id="smartBtn" onclick="smartPunch()" class="smart-btn btn-mode-in">
        <span>üìç</span> <span>PUNCH IN</span>
      </button>
      
      <div class="d-flex justify-content-center gap-3 mb-4">
         <button onclick="toggleOverride()" class="btn btn-link btn-sm text-muted text-decoration-none p-0">Switch Mode</button>
         <span class="text-muted small">|</span>
         <button onclick="openQRModal()" class="btn btn-link btn-sm text-warning fw-bold text-decoration-none p-0">üì∏ QR Backup (No GPS)</button>
      </div>

      <button onclick="openReportModal()" class="btn btn-outline-dark btn-sm w-100 mb-3">
        üìÑ View/Print Monthly Report
      </button>

      <hr class="opacity-25">
      <button onclick="doLogout()" class="btn btn-light btn-sm w-100 text-muted">Log Out</button>
    </div>
  </div>

  <div class="modal fade no-print" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h6 class="modal-title">Scan Backup QR</h6>
          <button type="button" class="btn-close btn-close-white" onclick="closeQRModal()"></button>
        </div>
        <div class="modal-body text-center p-0 bg-black">
          <div id="reader" style="width: 100%; min-height:300px;"></div>
        </div>
        <div class="modal-footer justify-content-center bg-light">
           <small class="text-muted">Point camera at the Reception Screen</small>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade no-print" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">Select Month</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body text-center">
          <input type="month" id="reportMonth" class="form-control mb-3">
          <button onclick="generateReport()" class="btn btn-primary w-100">Generate Punch Card</button>
        </div>
      </div>
    </div>
  </div>

  <div id="printSection">
    <div class="text-center mb-3 border-bottom pb-2">
      <h5 class="fw-bold mb-0">HOSPITAL PASIR GUDANG</h5>
      <small>Jabatan Bedah Mulut & Maksilofasial</small>
    </div>
    <div class="d-flex justify-content-between mb-3 small">
       <div>Name: <strong id="pName"></strong></div>
       <div>Month: <strong id="pMonth"></strong></div>
    </div>
    <table class="punch-table">
      <thead>
        <tr><th style="width:10%">Date</th><th style="width:12%">IN</th><th style="width:12%">OUT</th><th style="width:12%">IN</th><th style="width:12%">OUT</th><th style="width:12%">IN</th><th style="width:12%">OUT</th><th style="width:18%">Notes</th></tr>
      </thead>
      <tbody id="reportGrid"></tbody>
    </table>
    <div class="mt-4 text-center no-print">
      <button onclick="window.print()" class="btn btn-success btn-lg shadow">üñ®Ô∏è PRINT NOW</button>
      <button onclick="closeReport()" class="btn btn-secondary btn-lg ms-2">Back</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ==========================================
    // üî¥ PASTE YOUR WEB APP URL HERE üëá
    // ==========================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyemjwHotqvuwaVwa_mbxmNd6-6LGiu54YsdwuIHe4IaoO4wYR0V4JFKEL6VUi6V5FU/exec"; 
    
    const KEY = 'hpg_token';
    let html5QrcodeScanner = null; // Scanner instance

    // --- API HELPER ---
    function callApi(action, payload, cb) {
      document.getElementById('loadingOverlay').style.display = 'flex';
      payload.action = action;
      fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
      .then(r => r.json()).then(d => {
        document.getElementById('loadingOverlay').style.display = 'none';
        cb(d);
      }).catch(e => {
        document.getElementById('loadingOverlay').style.display = 'none';
        alert("Connection Error");
      });
    }

    // --- QR SCANNER LOGIC ---
    function openQRModal() {
       new bootstrap.Modal('#qrModal', {backdrop: 'static'}).show();
       
       // Delay start slightly to allow modal to render
       setTimeout(() => {
          if(!html5QrcodeScanner) {
             html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
             html5QrcodeScanner.render(onScanSuccess);
          }
       }, 500);
    }

    function closeQRModal() {
       if(html5QrcodeScanner) {
          html5QrcodeScanner.clear().then(() => {
             html5QrcodeScanner = null;
             // Remove backdrop manually if needed or just hide modal
             bootstrap.Modal.getInstance(document.getElementById('qrModal')).hide();
          }).catch(err => {
             console.error("Failed to clear scanner", err);
             bootstrap.Modal.getInstance(document.getElementById('qrModal')).hide();
          });
       } else {
          bootstrap.Modal.getInstance(document.getElementById('qrModal')).hide();
       }
    }

    function onScanSuccess(decodedText) {
       // Stop scanning immediately
       if(html5QrcodeScanner) {
          html5QrcodeScanner.clear();
          html5QrcodeScanner = null;
       }
       bootstrap.Modal.getInstance(document.getElementById('qrModal')).hide();

       // Determine Action from the main button state
       const act = document.getElementById('smartBtn').dataset.action;
       
       // Submit with dummy lat/lng but legitimate qrData
       callApi("punch", {
          key: localStorage.getItem(KEY),
          lat: 0, lng: 0, accuracy: 0, 
          ip: 'QR_Scan',
          act: act,
          qrData: decodedText
       }, r => {
          handlePunchResponse(r, act);
       });
    }

    // --- REPORT & APP LOGIC ---
    function openReportModal() {
       document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7);
       new bootstrap.Modal('#reportModal').show();
    }

    function generateReport() {
       const m = document.getElementById('reportMonth').value;
       if(!m) return;
       bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
       
       callApi("getReport", { key: localStorage.getItem(KEY), month: m }, r => {
          if(!r.success) return alert(r.msg);
          document.getElementById('pName').innerText = r.name;
          document.getElementById('pMonth').innerText = m;
          const tbody = document.getElementById('reportGrid');
          tbody.innerHTML = "";
          const days = new Date(m.split('-')[0], m.split('-')[1], 0).getDate();
          
          for(let i=1; i<=days; i++) {
             let tr = document.createElement('tr');
             let punches = r.data[i] || [];
             punches.sort(); 
             
             let fullDate = new Date(m + '-' + i);
             if(fullDate.getDay() === 0 || fullDate.getDay() === 6) tr.className = "weekend-row";

             let rowHtml = `<td><strong>${i}</strong></td>`;
             for(let j=0; j<6; j++) rowHtml += `<td>${punches[j] ? punches[j] : ""}</td>`;
             rowHtml += `<td></td>`;
             tr.innerHTML = rowHtml;
             tbody.appendChild(tr);
          }
          document.getElementById('mainApp').style.display = 'none';
          document.getElementById('printSection').style.display = 'block';
       });
    }

    function closeReport() {
       document.getElementById('printSection').style.display = 'none';
       document.getElementById('mainApp').style.display = 'block';
    }

    function reqOTP() { callApi("sendOTP", {email: document.getElementById('email').value}, r=>{ alert(r.msg); if(r.success) document.getElementById('otpArea').style.display='block'; }); }
    
    function doLogin() {
       callApi("verifyOTP", {email: document.getElementById('email').value, otp: document.getElementById('otp').value}, r=>{
         if(r.success) {
           localStorage.setItem(KEY, r.key); localStorage.setItem('name', r.name); localStorage.setItem('shift', r.shift);
           loadPunchView();
         } else alert(r.msg);
       });
    }
    
    function smartPunch() {
       const act = document.getElementById('smartBtn').dataset.action;
       if(!navigator.geolocation) return alert("No GPS");
       navigator.geolocation.getCurrentPosition(pos => {
          callApi("punch", {key: localStorage.getItem(KEY), lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: pos.coords.accuracy, ip:'Mobile', act: act}, r => {
             handlePunchResponse(r, act);
          });
       });
    }

    function handlePunchResponse(r, act) {
       if(r.success) {
          const now = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
          const type = act.includes("IN") ? "IN" : "OUT";
          localStorage.setItem('hpg_last_type', type);
          localStorage.setItem('hpg_last_time', now);
          updateLastActionUI();
          new bootstrap.Toast(document.getElementById('successToast')).show();
       } else alert(r.msg);
    }

    function updateLastActionUI() {
      const lastType = localStorage.getItem('hpg_last_type');
      const lastTime = localStorage.getItem('hpg_last_time');
      const btn = document.getElementById('smartBtn');
      const info = document.getElementById('lastActionText');
      const box = document.getElementById('lastActionBox');

      if(lastType === "IN") {
        btn.className = "smart-btn btn-mode-out";
        btn.innerHTML = "<span>üõë</span> <span>PUNCH OUT</span>";
        btn.dataset.action = "PUNCH OUT";
        info.innerText = "PUNCH IN at " + lastTime;
        box.className = "alert alert-success p-2 small mb-4";
      } else {
        btn.className = "smart-btn btn-mode-in";
        btn.innerHTML = "<span>üìç</span> <span>PUNCH IN</span>";
        btn.dataset.action = "PUNCH IN";
        info.innerText = (lastType === "OUT") ? "PUNCH OUT at " + lastTime : "No record today";
        box.className = (lastType === "OUT") ? "alert alert-warning p-2 small mb-4" : "alert alert-secondary p-2 small mb-4";
      }
    }

    function toggleOverride() {
       const curr = localStorage.getItem('hpg_last_type');
       localStorage.setItem('hpg_last_type', curr === "IN" ? "OUT" : "IN");
       updateLastActionUI();
    }

    function loadPunchView() {
       document.getElementById('loginView').classList.add('d-none');
       document.getElementById('punchView').classList.remove('d-none');
       document.getElementById('uName').innerText = localStorage.getItem('name');
       document.getElementById('uShift').innerText = localStorage.getItem('shift');
       updateLastActionUI();
    }
    
    function doLogout() { localStorage.clear(); location.reload(); }

    if(localStorage.getItem(KEY)) loadPunchView();
  </script>
</body>
</html>
