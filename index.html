<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>HPG Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* APP STYLES (Screen Only) */
    body { background: #f0f4f8; font-family: 'Poppins', sans-serif; padding: 20px; }
    .app-card { max-width: 400px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
    .smart-btn { width: 100%; height: 90px; border-radius: 15px; font-weight: 700; font-size: 1.4rem; border: none; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px; }
    .btn-in { background: #1cc88a; color: white; }
    .btn-out { background: #e74a3b; color: white; }
    
    /* REPORT CARD STYLES (Hidden by default, Visible on Print) */
    #printSection { display: none; background: white; font-family: 'Arial', sans-serif; color: black; }
    
    .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid black; padding-bottom: 10px; }
    .print-logo { font-size: 14px; font-weight: bold; text-transform: uppercase; }
    .print-info { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 12px; }
    
    .punch-table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .punch-table th, .punch-table td { border: 1px solid black; padding: 4px; text-align: center; height: 25px; }
    .punch-table th { background: #f0f0f0; font-weight: bold; }
    .weekend-row { background-color: #f8f9fa; }

    /* PRINT MEDIA QUERY - The Magic Part */
    @media print {
      body * { visibility: hidden; } /* Hide everything */
      #printSection, #printSection * { visibility: visible; } /* Show only report */
      #printSection { position: absolute; left: 0; top: 0; width: 100%; display: block !important; padding: 20px; }
      .no-print { display: none !important; }
    }
  </style>
</head>
<body>

  <div id="loader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);display:none;z-index:99;align-items:center;justify-content:center;">
    <div class="spinner-border text-primary"></div>
  </div>

  <div class="app-card no-print" id="mainApp">
    <div class="mb-4">
      <h5 class="fw-bold text-primary">HPG ATTENDANCE</h5>
      <small class="text-muted">Jabatan Bedah Mulut & Maksilofasial</small>
    </div>

    <div id="loginView">
      <input type="email" id="email" class="form-control mb-2 text-center" placeholder="Email">
      <button onclick="reqOTP()" class="btn btn-primary w-100 mb-2">Send Code</button>
      <div id="otpArea" style="display:none;">
        <input type="tel" id="otp" class="form-control mb-2 text-center" placeholder="OTP">
        <button onclick="doLogin()" class="btn btn-success w-100">Login</button>
      </div>
    </div>

    <div id="punchView" class="d-none">
      <h4 id="uName" class="fw-bold">Welcome</h4>
      <span id="uShift" class="badge bg-secondary mb-4">--</span>
      
      <button id="mainBtn" onclick="doPunch()" class="smart-btn btn-in">PUNCH IN</button>
      <div id="status" class="text-muted small fw-bold mb-3">Ready</div>
      
      <hr>
      
      <button onclick="openReportModal()" class="btn btn-outline-dark w-100 mb-3">
        üìÑ View My Monthly Report
      </button>

      <button onclick="doLogout()" class="btn btn-link text-muted btn-sm">Log Out</button>
    </div>
  </div>

  <div class="modal fade no-print" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title">Select Month</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body text-center">
          <input type="month" id="reportMonth" class="form-control mb-3">
          <button onclick="generateReport()" class="btn btn-primary w-100">Generate Report Card</button>
        </div>
      </div>
    </div>
  </div>

  <div id="printSection">
    <div class="print-header">
      <div class="print-logo">Hospital Pasir Gudang</div>
      <div style="font-size:12px;">Staff Attendance Record</div>
    </div>
    
    <div class="print-info">
      <div><strong>Name:</strong> <span id="pName"></span></div>
      <div><strong>Shift:</strong> <span id="pShift"></span></div>
      <div><strong>Month:</strong> <span id="pMonth"></span></div>
    </div>

    <table class="punch-table">
      <thead>
        <tr>
          <th style="width:15%">Date</th>
          <th style="width:35%">IN</th>
          <th style="width:35%">OUT</th>
          <th style="width:15%">Notes</th>
        </tr>
      </thead>
      <tbody id="reportGrid">
        </tbody>
    </table>
    
    <div class="mt-4 no-print text-center">
      <button onclick="window.print()" class="btn btn-success btn-lg px-5 shadow">üñ®Ô∏è PRINT NOW</button>
      <button onclick="closeReport()" class="btn btn-secondary btn-lg ms-2">Close</button>
    </div>
    
    <div class="mt-2 small text-muted text-center no-print">
      (Tip: If on mobile, select "Save to PDF" or "Share > Print")
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // üî¥ PASTE YOUR WEB APP URL HERE
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyemjwHotqvuwaVwa_mbxmNd6-6LGiu54YsdwuIHe4IaoO4wYR0V4JFKEL6VUi6V5FU/exec";
    const KEY = 'hpg_token';

    function callApi(action, payload, cb) {
      document.getElementById('loader').style.display='flex';
      payload.action = action;
      fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
        .then(r=>r.json()).then(d=>{ document.getElementById('loader').style.display='none'; cb(d); })
        .catch(e=>{ document.getElementById('loader').style.display='none'; alert("Error"); });
    }

    // --- REPORT LOGIC (CLIENT SIDE GENERATION) ---
    function openReportModal() {
      // Default to current month
      document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7);
      new bootstrap.Modal('#reportModal').show();
    }

    function generateReport() {
      const m = document.getElementById('reportMonth').value; // yyyy-mm
      if(!m) return;
      bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
      
      callApi("getReport", { key: localStorage.getItem(KEY), month: m }, r => {
        if(!r.success) return alert(r.msg);
        
        // 1. Fill Header Info
        document.getElementById('pName').innerText = r.name;
        document.getElementById('pShift').innerText = r.shift;
        document.getElementById('pMonth').innerText = m;
        
        // 2. Build Grid 1-31
        const tbody = document.getElementById('reportGrid');
        tbody.innerHTML = "";
        
        const daysInMonth = new Date(m.split('-')[0], m.split('-')[1], 0).getDate();
        
        for(let i=1; i<=31; i++) {
          if(i > daysInMonth) continue; // Skip days not in month (e.g., Feb 30)

          let tr = document.createElement('tr');
          
          // Data from server is keyed by day number (1, 2, 8...)
          let punches = r.data[i] || []; // Array like ["08:00", "17:00"]
          punches.sort(); // Ensure chronological
          
          let dateStr = `${i}/${m.split('-')[1]}`; // d/m
          
          // Determine weekend for styling
          let fullDate = new Date(m + '-' + i);
          let isWeekend = (fullDate.getDay() === 0 || fullDate.getDay() === 6);
          if(isWeekend) tr.className = "weekend-row";

          // Format IN/OUT (Takes first and last punch if multiple)
          let inTime = punches.length > 0 ? punches[0] : "";
          let outTime = punches.length > 1 ? punches[punches.length-1] : "";
          
          tr.innerHTML = `
            <td>${dateStr}</td>
            <td>${inTime}</td>
            <td>${outTime}</td>
            <td></td>
          `;
          tbody.appendChild(tr);
        }

        // 3. Show Print View
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('printSection').style.display = 'block';
      });
    }

    function closeReport() {
      document.getElementById('printSection').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
    }

    // --- STANDARD APP LOGIC ---
    function reqOTP() { callApi("sendOTP", {email: document.getElementById('email').value}, r=>{ alert(r.msg); if(r.success) document.getElementById('otpArea').style.display='block'; }); }
    
    function doLogin() { 
      callApi("verifyOTP", {email: document.getElementById('email').value, otp: document.getElementById('otp').value}, r=>{
        if(r.success){ 
          localStorage.setItem(KEY, r.key); localStorage.setItem('name', r.name); localStorage.setItem('shift', r.shift);
          loadDash();
        } else alert(r.msg);
      });
    }

    function doPunch() {
       if(!navigator.geolocation) return alert("No GPS");
       document.getElementById('status').innerText = "Locating...";
       navigator.geolocation.getCurrentPosition(pos => {
         // Simple Punch Toggle logic for demo
         let act = document.getElementById('mainBtn').innerText; 
         callApi("punch", {key: localStorage.getItem(KEY), lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: pos.coords.accuracy, ip: 'Mobile', act: act}, r=>{
            alert(r.msg);
            if(r.success && act=="PUNCH IN") {
               document.getElementById('mainBtn').innerText = "PUNCH OUT";
               document.getElementById('mainBtn').className = "smart-btn btn-out";
            } else if(r.success) {
               document.getElementById('mainBtn').innerText = "PUNCH IN";
               document.getElementById('mainBtn').className = "smart-btn btn-in";
            }
            document.getElementById('status').innerText = r.msg;
         });
       });
    }
    
    function loadDash() {
      document.getElementById('loginView').classList.add('d-none');
      document.getElementById('punchView').classList.remove('d-none');
      document.getElementById('uName').innerText = localStorage.getItem('name');
      document.getElementById('uShift').innerText = localStorage.getItem('shift');
    }
    
    function doLogout() { localStorage.clear(); location.reload(); }

    if(localStorage.getItem(KEY)) loadDash();
  </script>
</body>
</html>
